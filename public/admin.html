<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Product Management</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
</head>
<body>
    <div class="admin-container">
        <h2>Admin Panel - Product Management</h2>
        <form id="addProductForm" class="admin-form">
            <h3>Add New Product</h3>
            <input type="text" id="name" placeholder="Product Name" required>
            <input type="number" id="price" placeholder="Price" required>
            <input type="text" id="image" placeholder="Image Path (e.g. uploaded_img/pizza-1.png)" required>
            <select id="category" required>
                <option value="">Select Category</option>
                <option value="Fast Food">Fast Food</option>
                <option value="Dishes">Dishes</option>
                <option value="Drinks">Drinks</option>
                <option value="Dessert">Dessert</option>
            </select>
            <input type="text" id="description" placeholder="Description" required>
            <button type="submit">Add Product</button>
        </form>
        <h3>All Products</h3>
        <table class="admin-table" id="productsTable">
            <thead>
                <tr>
                    <th>Image</th>
                    <th>Name</th>
                    <th>Price</th>
                    <th>Category</th>
                    <th>Description</th>
                    <th>Edit</th>
                    <th>Delete</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
        <hr style="margin:32px 0;">
        <h3>Contact Messages</h3>
        <table class="admin-table" id="messagesTable">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Number</th>
                    <th>Message</th>
                    <th>Date</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <hr style="margin:32px 0;">
        <h3>All Users</h3>
        <table class="admin-table" id="usersTable">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Address</th>
                    <th>Save</th>
                    <th>Delete</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <hr style="margin:32px 0;">
        <h3>Order History</h3>
        <table class="admin-table" id="ordersTable">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>User Email</th>
                    <th>Items</th>
                    <th>Total</th>
                    <th>Payment Method</th>
                    <th>Delete</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    <script>
    // --- Admin Page Password Prompt ---
    (function() {
        const ADMIN_PASS = 'admin123'; // Change as needed
        if (!sessionStorage.getItem('admin_authed')) {
            let pass = prompt('Enter admin password to view this page:');
            if (pass !== ADMIN_PASS) {
                alert('Incorrect password!');
                window.location.href = 'index.html';
            } else {
                sessionStorage.setItem('admin_authed', '1');
            }
        }
    })();
        let editingId = null;
        async function fetchProducts() {
            const res = await fetch('/admin/products');
            const products = await res.json();
            const tbody = document.querySelector('#productsTable tbody');
            tbody.innerHTML = '';
            products.forEach(prod => {
                const tr = document.createElement('tr');
                if (editingId === prod._id) {
                    tr.innerHTML = `
                        <td><input type="text" value="${prod.image}" id="edit-image"></td>
                        <td><input type="text" value="${prod.name}" id="edit-name"></td>
                        <td><input type="number" value="${prod.price}" id="edit-price"></td>
                        <td><select id="edit-category">
                            <option value="Fast Food" ${prod.category==="Fast Food"?"selected":''}>Fast Food</option>
                            <option value="Dishes" ${prod.category==="Dishes"?"selected":''}>Dishes</option>
                            <option value="Drinks" ${prod.category==="Drinks"?"selected":''}>Drinks</option>
                            <option value="Dessert" ${prod.category==="Dessert"?"selected":''}>Dessert</option>
                        </select></td>
                        <td><input type="text" value="${prod.description}" id="edit-description"></td>
                        <td style="text-align:center;">
                            <button onclick="saveEdit('${prod._id}')" title="Save" style="background:#27ae60;color:#fff;">
                                <i class="fa-solid fa-floppy-disk"></i>
                            </button>
                            <button onclick="cancelEdit()" title="Cancel" style="background:#aaa;color:#fff;">
                                <i class="fa-solid fa-xmark"></i>
                            </button>
                        </td>
                        <td></td>
                    `;
                } else {
                    tr.innerHTML = `
                        <td><img src="${prod.image}" alt="${prod.name}"></td>
                        <td>${prod.name}</td>
                        <td>â‚¹${prod.price}</td>
                        <td>${prod.category}</td>
                        <td>${prod.description}</td>
                        <td style="text-align:center;">
                            <button onclick="editProduct('${prod._id}')" title="Edit" style="background:#2980b9;color:#fff;">
                                <i class="fa-solid fa-pen-to-square"></i>
                            </button>
                        </td>
                        <td style="text-align:center;">
                            <button class="delete" onclick="deleteProduct('${prod._id}')" title="Delete" style="background:#e74c3c;color:#fff;">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </td>
                    `;
                }
                tbody.appendChild(tr);
            });
        }
        function editProduct(id) {
            editingId = id;
            fetchProducts();
        }
        function cancelEdit() {
            editingId = null;
            fetchProducts();
        }
        async function saveEdit(id) {
            const data = {
                name: document.getElementById('edit-name').value,
                price: document.getElementById('edit-price').value,
                image: document.getElementById('edit-image').value,
                category: document.getElementById('edit-category').value,
                description: document.getElementById('edit-description').value
            };
            await fetch(`/admin/products/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            editingId = null;
            fetchProducts();
        }
        async function deleteProduct(id) {
            if (!confirm('Delete this product?')) return;
            await fetch(`/admin/products/${id}`, {
                method: 'DELETE',
            });
            fetchProducts();
        }
        document.getElementById('addProductForm').onsubmit = async function(e) {
            e.preventDefault();
            const data = {
                name: document.getElementById('name').value,
                price: document.getElementById('price').value,
                image: document.getElementById('image').value,
                category: document.getElementById('category').value,
                description: document.getElementById('description').value
            };
            await fetch('/admin/products', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            this.reset();
            await fetchProducts();
        };
        async function fetchMessages() {
            const res = await fetch('/admin/messages');
            const messages = await res.json();
            const tbody = document.querySelector('#messagesTable tbody');
            tbody.innerHTML = '';
            messages.forEach(msg => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${msg.name}</td>
                    <td>${msg.email}</td>
                    <td>${msg.number}</td>
                    <td>${msg.msg}</td>
                    <td>${new Date(msg.createdAt).toLocaleString()}</td>
                `;
                tbody.appendChild(tr);
            });
        }
        async function fetchUsers() {
            const res = await fetch('/admin/users');
            const users = await res.json();
            const tbody = document.querySelector('#usersTable tbody');
            tbody.innerHTML = '';
            users.forEach(user => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input type="text" value="${user.name}" data-id="${user._id}" class="edit-user-name"></td>
                    <td><input type="email" value="${user.email}" data-id="${user._id}" class="edit-user-email"></td>
                    <td><input type="text" value="${user.number}" data-id="${user._id}" class="edit-user-number"></td>
                    <td><input type="text" value="${user.address}" data-id="${user._id}" class="edit-user-address"></td>
                    <td style="text-align:center;">
                        <button onclick="saveUserEdit('${user._id}')" title="Save" style="background:#27ae60;color:#fff;">
                            <i class="fa-solid fa-floppy-disk"></i>
                        </button>
                    </td>
                    <td style="text-align:center;">
                        <button onclick="deleteUser('${user._id}')" title="Delete" style="background:#e74c3c;color:#fff;">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        async function saveUserEdit(id) {
            const name = document.querySelector(`.edit-user-name[data-id='${id}']`).value;
            const email = document.querySelector(`.edit-user-email[data-id='${id}']`).value;
            const number = document.querySelector(`.edit-user-number[data-id='${id}']`).value;
            const address = document.querySelector(`.edit-user-address[data-id='${id}']`).value;
            const res = await fetch(`/admin/users/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, email, number, address })
            });
            if (res.ok) {
                alert('User updated!');
                fetchUsers();
            } else {
                alert('Failed to update user');
            }
        }
        async function deleteUser(id) {
            if (!confirm('Are you sure you want to delete this user?')) return;
            const res = await fetch(`/admin/users/${id}`, { method: 'DELETE' });
            if (res.ok) {
                alert('User deleted!');
                fetchUsers();
            } else {
                alert('Failed to delete user');
            }
        }
        async function fetchOrders() {
            const res = await fetch('/admin/orders');
            const orders = await res.json();
            const tbody = document.querySelector('#ordersTable tbody');
            tbody.innerHTML = '';
            orders.forEach(order => {
                const date = new Date(order.createdAt).toLocaleString();
                const items = order.items.map(i => `${i.name} (${i.quantity})`).join(' - ');
                const payment = order.method ? order.method : 'Cash On Delivery';
                tbody.innerHTML += `
                    <tr>
                        <td>${date}</td>
                        <td>${order.userEmail}</td>
                        <td>${items}</td>
                        <td>â‚¹${order.total}</td>
                        <td>${payment}</td>
                        <td style="text-align:center;">
                            <button onclick="deleteOrder('${order._id}')" title="Delete" style="background:#e74c3c;color:#fff;"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });
        }
        async function deleteOrder(id) {
            if (!confirm('Are you sure you want to delete this order?')) return;
            const res = await fetch(`/admin/orders/${id}`, { method: 'DELETE' });
            if (res.ok) {
                alert('Order deleted!');
                fetchOrders();
            } else {
                alert('Failed to delete order');
            }
        }
        document.addEventListener('DOMContentLoaded', () => {
            fetchProducts();
            fetchMessages();
            fetchUsers();
            fetchOrders();
        });
    </script>
</body>
</html>
